#!/bin/bash -e

source $OPENSHIFT_CARTRIDGE_SDK_BASH

HADOOP_BIN_DIR=${OPENSHIFT_HADOOP_DIR}/bin

cartridge_type="hadoop"
version=2.4

HADOOP_RM_PID_FILE="/tmp/hadoop_rm.pid"
HADOOP_NM_PID_FILE="/tmp/hadoop_nm.pid"

function build() {
  echo "Building Hadoop"

}

function deploy() {
  echo "Deploying Hadoop"
  
}


isrunning() {
    # Check for running app
    if [ -f "$HADOOP_NM_PID_FILE" ]; then
      pid=$(cat $HADOOP_NM_PID_FILE);
      running=`/bin/ps --no-headers --pid $pid`
      if test -n "$running";
      then
        return 0
      fi
    fi
    # not running
    return 1
}

function start() {
  echo "Starting $cartridge_type cart"
  
  # Check for running app
  if isrunning; then
      echo "Application is already running"
  else    
    pushd ${OPENSHIFT_HADOOP_DIR}/hadoop
    	sbin/yarn-daemon.sh start resourcemanager 2>&1 &
    	PROCESS_ID=$!
    	echo $PROCESS_ID > $HADOOP_RM_PID_FILE
    
        sbin/yarn-daemon.sh start nodemanager 2>&1 &
        PROCESS_ID=$!
        echo $PROCESS_ID > $HADOOP_NM_PID_FILE
    popd
  fi
}

# Kill the process given by $1 and its children
killtree() {
    local _pid=$1
    for _child in $(ps -o pid --no-headers --ppid ${_pid}); do
        killtree ${_child}
    done

    local should_be_gone_pid=$(ps -o pid -p ${_pid} --no-headers)
    if [ -z $should_be_gone_pid ]; then
        return
    else
        kill -TERM ${_pid}
    fi

    local count=0
    while [ ${count} -lt 15 ]
    do
        local should_be_gone_pid=$(ps -o pid -p ${_pid} --no-headers)
        if [ -z $should_be_gone_pid ]; then
                return
        else
                sleep 2
                let count=${count}+1
        fi
    done

    local should_be_gone_pid=$(ps -o pid -p ${_pid} --no-headers)
    if [ ! -z $should_be_gone_pid ]
    then
        kill -9 ${_pid}
    fi
}


function stop() {
  	echo "Stopping $cartridge_type cart"
  	
  	if isrunning; then
    	if [ -f "$HADOOP_NM_PID_FILE" ]; then
      		pid=$(cat $HADOOP_NM_PID_FILE);
      		echo "Sending SIGTERM to hadoop:$pid ..." 1>&2
      		killtree $pid
                if [ -f "$HADOOP_RM_PID_FILE" ]; then
                	pid=$(cat $HADOOP_RM_PID_FILE);
                	echo "Sending SIGTERM to hadoop:$pid ..." 1>&2
                	killtree $pid
		fi
    	else
      		echo "Failed to locate HADOOP PID File" 1>&2
    	fi
  fi
  
}

function restart() {
    echo "Restarting $cartridge_type cart"
   
  	stop
  	
  	start
}

function status() {
   if isrunning
   then
      echo "Application is running"
   else
      echo "Application is either stopped or inaccessible"
   fi
}

function reload() {
    echo "Reloading $cartridge_type cart"
    restart
}

# Clean up any log files
function tidy() {
  client_message "Emptying log dir: $OPENSHIFT_HADOOP_LOG_DIR"
  shopt -s dotglob
  rm -rf $OPENSHIFT_HADOOP_LOG_DIR/*
}

case "$1" in
  build)		build ;;
  deploy)	    deploy ;;
  start)     	start ;;
  stop)      	stop ;;
  restart)   	restart ;;
  status)    	status ;;
  reload)    	reload ;;
  tidy)      	tidy ;;
  *)         	exit 0
esac


